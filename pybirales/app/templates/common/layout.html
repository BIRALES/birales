<html>
<head>
    {% block head %}
        <title>BIRALES | {% block title %}{% endblock %}</title>

        <link rel="shortcut icon" href="{{ url_for('static', filename='img/birales_logo.png') }}">

        <!-- Bootstrap core CSS -->
        <link rel="stylesheet"
              href="{{ url_for('static', filename='node_modules/bootstrap/dist/css/bootstrap.min.css') }}">
        <!--  Light Bootstrap Table core CSS -->
        <link rel="stylesheet"
              href="{{ url_for('static', filename='themes/lbd/assets/css/light-bootstrap-dashboard.css') }}">
        <!-- Font Awesome -->
        <link rel="stylesheet"
              href="{{ url_for('static', filename='node_modules/font-awesome/css/font-awesome.min.css') }}">
        <link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="{{ url_for('static', filename='themes/lbd/assets/css/pe-icon-7-stroke.css') }}"/>


        <link rel="stylesheet"
              href="{{ url_for('static', filename='node_modules/flatpickr/dist/flatpickr.min.css') }}">
        <link rel="stylesheet"
              href="{{ url_for('static', filename='node_modules/dropzone/dist/min/dropzone.min.css') }}">
        <link rel="stylesheet"
              href="{{ url_for('static', filename='node_modules/toastr/build/toastr.min.css') }}">
        <link rel="stylesheet"
              href="{{ url_for('static', filename='node_modules/bootstrap-toggle/css/bootstrap-toggle.min.css') }}">
        <link href="//cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" rel="stylesheet"/>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/side_panel.css') }}"/>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/loader.css') }}"/>

        <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}"/>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}"/>
    {% endblock %}
</head>
<body>

<div id="birales-not-available-container" class="full-width-overlay" style="width: 100%; display: none">
    <div class="full-width-overlay-content">
        <p>
            The BIRALES system is not available. <br/>
            Please contact your system administrator.
        </p>
    </div>
</div>


<div class="wrapper">
    <div class="sidebar" data-color="dark-blue" data-image="{{ url_for('static', filename='img/nord_cross.png') }}">
        <div class="sidebar-wrapper">
            <div class="logo">
                <a href="/" class="simple-text">
                    <strong>BIRALES_TPM</strong>
                </a>
            </div>

            <ul class="nav">
                <li {% if active_page == 'monitoring' %} class="active" {% endif %}>
                    <a href="{{ url_for('monitoring_page.index') }}">
                        <i class="pe-7s-graph2"></i>
                        <p>Monitoring</p>
                    </a>
                </li>
                <li {% if active_page == 'observations' %} class="active" {% endif %}>
                    <a href="{{ url_for('observations_page.index') }}">
                        <i class="pe-7s-glasses"></i>
                        <p>Observations</p>
                    </a>
                </li>
                <li {% if active_page == 'events' %} class="active" {% endif %}>
                    <a href="{{ url_for('events_page.index') }}">
                        <i class="pe-7s-note2"></i>

                        <p>Events</p>
                    </a>
                </li>
                <li {% if active_page == 'configurations' %} class="active" {% endif %}>
                    <a href="{{ url_for('configurations_page.edit') }}">
                        <i class="pe-7s-config"></i>

                        <p>Configuration</p>
                    </a>
                </li>

                <li class="stop-obs">
                    <a id="obs-stop-btn" class="btn blink" style="display: none">
                        {#                        <i class="pe-7s-close"></i>#}
                        Stop Observation
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="main-panel">
        <nav class="navbar navbar-default navbar-fixed">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse"
                            data-target="#navigation-example-2">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#">{% block page_title %}{% endblock %}</a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                    </ul>
                </div>
            </div>
        </nav>

        <div class="content">
            {% block content %}{% endblock %}
        </div>

        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-xs-4">
                        <div class="col-xs-6">
                            <div id="inaf_logo" class="footer-img"></div>
                        </div>
                        <div class="col-xs-6">
                            <div id="uom_logo" class="footer-img"></div>
                        </div>
                    </div>
                    <div class="col-xs-8">
                        <p class="copyright pull-right">BIRALES</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>
</div>

{% block scripts %}
    <!-- Bootstrap -->
    <script src="{{ url_for('static', filename='node_modules/loglevel/dist/loglevel.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/moment/min/moment.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/colorbrewer/index.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/jquery/dist/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/bootstrap/dist/js/bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='themes/lbd/assets/js/light-bootstrap-dashboard.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/toastr/toastr.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/socket.io-client/dist/socket.io.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/plotly.js/dist/plotly.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/chart.js/dist/Chart.min.js') }}"></script>

    <script src="{{ url_for('static', filename='node_modules/flatpickr/dist/flatpickr.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/bootstrap-toggle/js/bootstrap-toggle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/selectric/public/jquery.selectric.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/dropzone/dist/dropzone.js') }}"></script>
    <script src="//cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>


    <script>
        $(document).ready(function () {
            {# Get Server side messages #}
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for level, message in messages %}
                        notifications.publish("{{ message }}", "{{ level }}");
                    {% endfor %}
                {% endif %}
            {% endwith %}

            let obs_stop_btn = $('#obs-stop-btn');
            let failed_requests = 0;
            let last_updated_status_time = moment.utc();
            let last_updated_scheduler_status_time = moment.utc();
            let expiry_dt = 5; // Time at which the pipeline is deemed to no longer be running (in seconds)
            let birales_unavailable_overlay = $('#birales-not-available-container');
            let observation_running = false; // A flag that is flipped when an observation is running


            function events_polling(last_updated) {

                if (failed_requests > 5) {
                    log.error('Stopping polling as server is not responsive');
                    return
                }

                $.ajax({
                    url: '/api/events',
                    method: "POST",
                    timeout: 8000,
                    data: {from_date: last_updated.toISOString()}
                }).done(function (response) {
                    let data = JSON.parse(response);
                    let events = JSON.parse(data.events);
                    log.debug(events.length + ' events since ' + last_updated.toISOString());

                    $.each(events, function (i, event) {
                        log.debug('Notification:', event.header.level, event.body);
                        notifications.publish(event.body, event.header.level);
                    });

                    last_updated = new Date(data.timestamp);

                    failed_requests = 0;
                }).fail(function (error) {
                    failed_requests += 1;

                    // After 5 failed requests, we terminate polling and prompt the user
                    if (failed_requests > 5) {
                        notifications.publish('Cannot reach server. Please contact admin.', 'error')
                    }

                    log.error(error)
                });

                setTimeout(function () {
                    events_polling(last_updated)
                }, 5000);
            }

            // Poll for newar events
            events_polling(new Date());


            {#Giving broken pipe errors#}


            socket.on('connect', function () {
                console.log('connected to server');
                socket.on('disconnect', function () {
                    console.log('disconnected from server2');
                });
            });

            socket.on('disconnect', function () {
                console.log('disconnected from server');
            });

            socket.on('error', function (err) {
                console.log('An error has occurred on server side.', err);
            });

            function poll_system_status() {
                if (obs_stop_btn.is(":visible")) {
                    if ((new Date() - last_updated_status_time) > expiry_dt * 1000) {
                        log.info('Observation is no longer running. Last updated at: ' + last_updated_status_time + '. Hiding stop button.');
                        obs_stop_btn.hide();

                        observation_running = false;
                    }
                }

                if (((new Date() - last_updated_scheduler_status_time) > expiry_dt * 1000 * 3) & observation_running === false) {
                    log.info('Scheduler is no longer running. Last updated at: ' + last_updated_scheduler_status_time.format() + '. Showing dialog.');
                    birales_unavailable_overlay.show();
                }



                setTimeout(poll_system_status, 5000);
            }

            // Check for a change in system status every 5 seconds
            poll_system_status();

            socket.on('status', function (response) {
                let data = JSON.parse(response);

                if (data.pipeline !== undefined) {
                    if (data.pipeline.status === 'running') {
                        log.debug('Observation is running');
                        obs_stop_btn.fadeIn('slow');

                        last_updated_status_time = moment.utc(data.pipeline.timestamp);
                        obs_stop_btn.show();

                        observation_running = true;

                        // If a pipeline is running, the 'system not available' should not be shown
                        if (birales_unavailable_overlay.is(":visible")) {
                            birales_unavailable_overlay.hide();
                        }
                    }
                }

                if (data.scheduler !== undefined) {
                    if (data.scheduler.status === 'running') {
                        log.debug('Scheduler is available');
                        last_updated_scheduler_status_time = moment.utc(data.scheduler.timestamp);
                        if (birales_unavailable_overlay.is(":visible")) {
                            birales_unavailable_overlay.hide();
                        }

                        if (data.scheduler.obs_thread_status === false) {
                            log.error('Observation thread is dead');
                        }
                    }
                }

            });

            obs_stop_btn.click(function () {
                $.ajax({
                    url: '/api/stop',
                    method: "POST",
                    timeout: 8000,
                }).done(function (response) {
                    log.info('Stop observation command sent.', response);

                    obs_stop_btn.hide()
                }).fail(function (error) {
                    log.error(error)
                });
            });
        });
    </script>
{% endblock %}

</body>
</html>
