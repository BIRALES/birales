<html>
<head>
    {% block head %}
        <title>BIRALES | {% block title %}{% endblock %}</title>

        <link rel="shortcut icon" href="{{ url_for('static', filename='img/birales_logo.png') }}">

        <!-- Bootstrap core CSS -->
        <link rel="stylesheet"
              href="{{ url_for('static', filename='node_modules/bootstrap/dist/css/bootstrap.min.css') }}">
        <!--  Light Bootstrap Table core CSS -->
        <link rel="stylesheet"
              href="{{ url_for('static', filename='themes/lbd/assets/css/light-bootstrap-dashboard.css') }}">
        <!-- Font Awesome -->
        <link rel="stylesheet"
              href="{{ url_for('static', filename='node_modules/font-awesome/css/font-awesome.min.css') }}">
        <link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="{{ url_for('static', filename='themes/lbd/assets/css/pe-icon-7-stroke.css') }}"/>


        <link rel="stylesheet"
              href="{{ url_for('static', filename='node_modules/flatpickr/dist/flatpickr.min.css') }}">
        <link rel="stylesheet"
              href="{{ url_for('static', filename='node_modules/dropzone/dist/min/dropzone.min.css') }}">
        <link rel="stylesheet"
              href="{{ url_for('static', filename='node_modules/toastr/build/toastr.min.css') }}">
        <link rel="stylesheet"
              href="{{ url_for('static', filename='node_modules/bootstrap-toggle/css/bootstrap-toggle.min.css') }}">
        <link href="//cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" rel="stylesheet"/>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/side_panel.css') }}"/>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/loader.css') }}"/>

        <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}"/>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}"/>
    {% endblock %}
</head>
<body>
<div class="wrapper">
    <div class="sidebar" data-color="blue" data-image="{{ url_for('static', filename='img/nord_cross.png') }}">
        <div class="sidebar-wrapper">
            <div class="logo">
                <a href="/" class="simple-text">
                    BIRALES 2.0
                </a>
            </div>

            <ul class="nav">
                <li {% if active_page == 'monitoring' %} class="active" {% endif %}>
                    <a href="{{ url_for('monitoring_page.index') }}">
                        <i class="pe-7s-graph2"></i>
                        <p>Monitoring</p>
                    </a>
                </li>
                <li {% if active_page == 'observations' %} class="active" {% endif %}>
                    <a href="{{ url_for('observations_page.index') }}">
                        <i class="pe-7s-glasses"></i>
                        <p>Observations</p>
                    </a>
                </li>
                <li {% if active_page == 'system-log' %} class="active" {% endif %}>
                    <a href="{{ url_for('configurations_page.index') }}">
                        <i class="pe-7s-note2"></i>

                        <p>System Log</p>
                    </a>
                </li>
                <li {% if active_page == 'configurations' %} class="active" {% endif %}>
                    <a href="{{ url_for('configurations_page.index') }}">
                        <i class="pe-7s-config"></i>

                        <p>Configurations</p>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="main-panel">
        <nav class="navbar navbar-default navbar-fixed">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse"
                            data-target="#navigation-example-2">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#">Monitoring</a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                    </ul>
                </div>
            </div>
        </nav>

        <div class="content">
            {% block content %}{% endblock %}
        </div>

        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-xs-4">
                        <div class="col-xs-6">
                            <div id="inaf_logo" class="footer-img"></div>
                        </div>
                        <div class="col-xs-6">
                            <div id="uom_logo" class="footer-img"></div>
                        </div>
                    </div>
                    <div class="col-xs-8">
                        <p class="copyright pull-right"><a href="">BIRALES</a></p>
                    </div>
                </div>
                {#                <nav class="pull-left">#}
                {#                    <ul class="nav-footer-logos">#}
                {#                        <li>#}
                {#                            <a class="nav-footer-logo" href="#">#}
                {#                                <img src="{{ url_for('static', filename='img/inaf_logo.svg') }}"/>#}
                {#                            </a>#}
                {#                        </li>#}
                {#                        <li>#}
                {#                            <a class="nav-footer-logo" href="#">#}
                {#                                <img src="{{ url_for('static', filename='img/uom_logo.svg') }}"/>#}
                {#                            </a>#}
                {#                        </li>#}
                {#                    </ul>#}
                {#                </nav>#}
                {#                <p class="copyright pull-right"><a href="">BIRALES</a></p>#}
            </div>
        </footer>
    </div>
</div>

{% block scripts %}
    <!-- Bootstrap -->
    <script src="{{ url_for('static', filename='node_modules/loglevel/dist/loglevel.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/moment/min/moment.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/colorbrewer/index.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/jquery/dist/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/bootstrap/dist/js/bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='themes/lbd/assets/js/light-bootstrap-dashboard.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/toastr/toastr.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/socket.io-client/dist/socket.io.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/plotly.js/dist/plotly.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/chart.js/dist/Chart.min.js') }}"></script>

    <script src="{{ url_for('static', filename='node_modules/flatpickr/dist/flatpickr.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/bootstrap-toggle/js/bootstrap-toggle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/selectric/public/jquery.selectric.min.js') }}"></script>
    <script src="{{ url_for('static', filename='node_modules/dropzone/dist/dropzone.js') }}"></script>
    <script src="//cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>


    <script>
        $(document).ready(function () {
            {# Get Server side messages #}
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for level, message in messages %}
                        notifications.publish("{{ message }}", "{{ level }}");
                    {% endfor %}
                {% endif %}
            {% endwith %}

            let failed_requests = 0;
            let last_updated = new Date();

            function events_polling() {

                log.debug('Fetching new data since', last_updated.toISOString());

                if (failed_requests > 5) {
                    log.error('Stopping polling as server is not responsive');
                    return
                }

                $.ajax({
                    url: '/api/events',
                    method: "POST",
                    timeout: 8000,
                    data: {from_date: last_updated.toISOString()}
                }).done(function (response) {
                    let events = JSON.parse(response);
                    log.debug('Received', events.length, 'events');

                    $.each(events, function (i, event) {
                        log.debug('Notification:', event.header.level, event.body);
                        notifications.publish(event.body, event.header.level);

                        let created_at = new Date(event.created_at.$date);
                        if (created_at > last_updated) {
                            last_updated = created_at;
                        }
                    });

                    failed_requests = 0;
                }).fail(function (error) {
                    failed_requests += 1;

                    // After 5 failed requests, we terminate polling and prompt the user
                    if (failed_requests > 5) {
                        notifications.publish('Cannot reach server. Please contact admin.', 'error')
                    }

                    log.error(error)
                });
                setTimeout(events_polling, 5000);
            }

            // Poll for new events
            events_polling();
            /*
            Giving broken pipe errors

            var socket = io.connect('http://', {
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: 99999
            });
            socket.on('connect', function () {
                console.log('connected to server');
                socket.on('disconnect', function () {
                    console.log('disconnected from server2');
                });


            });

            socket.on('disconnect', function () {
                console.log('disconnected from server');
            });

            socket.on('error', function (err) {
                console.log('An error has occurred on server side.', err);
            });

            socket.on('message', function (data) {
                console.log(data)
            });

            */
        });
    </script>
{% endblock %}

</body>
</html>