<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Orbit determination input">
    <meta name="author" content="">

    <title>Orbit Determination | {{ observation }} - {{ data_set }}</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"
          integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <style>
        td.od_value {
            font-size: 70%;
            margin-left: 40px;
            word-break: break-all;
        }
    </style>

    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Numeric JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
</head>
<body>

<div class="container">
    <div class="page-header">
        <h1>Multi-Beam</h1>
        <h2>Observation <b>medicina_26_05_2016</b> and data set <b>norad_29499</b></h2>
    </div>
    <div class="row">
        <div class="col-md-8">
            <div id="beam-candidates-plot"></div>
        </div>
        <div class="col-md-4">
            <div id="multi-beam-configuration-plot"></div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.3.min.js"
        integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="
        crossorigin="anonymous">
</script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous">
</script>


<script>
    function get_multi_beam_configuration(observation, data_set, selector) {
        var data_url = "http://127.0.0.1:5000/monitoring/" + observation + "/" + data_set + "/multi_beam/configuration";

        $.ajax({
            url: data_url,
            success: function (pointings) {
                var reference = pointings['config']['reference_pointing'];
                var beam_pointings = pointings['config']['pointings'];
                var shapes = [];
                var data = [{
                    x: [],
                    y: [],
                    text: [],
                    mode: 'text'
                }];
                $(beam_pointings).each(function (beam_id, pointing_data) {
                    ra = pointing_data[0];
                    dec = pointing_data[1];
                    bw_ra = 1.75;
                    bw_dec = 0.5;

                    shape = {
                        type: 'circle',
                        xref: 'x',
                        yref: 'y',
                        x0: reference[0] + ra,
                        x1: reference[0] + ra + bw_ra,
                        y0: reference[1] + dec,
                        y1: reference[1] + dec + bw_dec
                    };
                    data[0].x.push(reference[0] + ra + (bw_ra * 0.5));
                    data[0].y.push(reference[1] + dec + (bw_dec * 0.5));
                    data[0].text.push(beam_id);

                    shapes.push(shape);
                });

                var layout = {
                    title: 'MultiBeam',
                    xaxis: {
                        autorange: true,
                        title: 'ra (deg)'
                    },
                    yaxis: {
                        autorange: true,
                        title: 'dec (deg)'
                    },
                    width: 500,
                    height: 500,
                    shapes: shapes
                };

                Plotly.newPlot(selector, data, layout);
            }
        });
    }

    function get_multi_beam_candidates(observation, data_set, selector) {
        var data_url = "http://127.0.0.1:5000/monitoring/" + observation + "/" + data_set + "/multi_beam/beam_candidates";

        $.ajax({
            url: data_url,
            success: function (beam_data) {
                var beams = beam_data['beams'];
                var traces = [];
                $.each(beams, function (i, beam) {
                    $.each(beam, function (j, beam_candidate) {
                        var beam_candidates_trace = {
                            x: beam_candidate.data['frequency'],
                            y: beam_candidate.data['time'],
                            mode: 'markers',
                            type: 'scatter',
                            name: 'beam ' + beam_candidate.beam_id + ' candidate ' + j,
                            marker: {
                                size: beam_candidate.data['snr'] * 10.
                            }
                        };
                        traces.push(beam_candidates_trace)
                    });
                });

                var layout = {
                    title: 'Beam Candidates Detected',
                    xaxis: {
                        autorange: true,
                        title: 'Channel (MHz)'
                    },
                    yaxis: {
                        autorange: true,
                        title: 'Time sample'
                    }
                };

                Plotly.newPlot(selector, traces, layout);
            }
        })
        ;
    }

    $(document).ready(function () {
        var observation = "medicina_26_05_2016";
        var data_set = "norad_29499";

        var pointings_plot_selector = "multi-beam-configuration-plot";
        var beam_candidates_plot_selector = "beam-candidates-plot";

        get_multi_beam_configuration(observation, data_set, pointings_plot_selector);
        get_multi_beam_candidates(observation, data_set, beam_candidates_plot_selector);
    });

</script>
</body>
</html>